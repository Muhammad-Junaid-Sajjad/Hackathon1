---
id: m1-c2-s5
title: Launch Files and Multi-Node Orchestration
sidebar_position: 5
keywords: ['launch', 'orchestration', 'multi-node', 'ros2-launch', 'bringup']
---

# Launch Files and Multi-Node Orchestration

## Prerequisites

| Requirement | Description |
|-------------|-------------|
| **M1-C1-S4** | ROS 2 Humble installed and workspace setup |
| **M1-C1-S5** | Understanding of ROS 2 nodes and topics |
| **M1-C2-S3** | Parameters and YAML configuration |
| **Python** | Basic Python syntax for launch files |

## Learning Objectives

By the end of this section, you will be able to:

1. **Create launch files** that start multiple nodes with one command
2. **Configure parameters** via YAML files and inline dictionaries
3. **Use launch arguments** for conditional execution
4. **Nest launch files** for modular system orchestration
5. **Handle lifecycle events** for node startup/shutdown dependencies

## Key Concepts

| Concept | Description | Example |
|---------|-------------|---------|
| **LaunchDescription** | Container for launch actions | `LaunchDescription([...])` |
| **Node** | Start a single ROS 2 node | `Node(package='pkg', executable='exe')` |
| **DeclareLaunchArgument** | Define CLI arguments | `use_sim:=true` |
| **IncludeLaunchDescription** | Nest launch files | Include perception stack |
| **IfCondition/UnlessCondition** | Conditional node launch | Real vs. simulation |
| **RegisterEventHandler** | React to node lifecycle | Shutdown on camera failure |

```
┌─────────────────────────────────────────────────────────────────┐
│                   Launch File Architecture                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                   humanoid_bringup.launch.py                    │
│                           (top-level)                            │
│                              │                                   │
│           ┌──────────────────┼──────────────────┐               │
│           ▼                  ▼                  ▼               │
│   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐      │
│   │  perception   │  │  navigation   │  │  manipulation │      │
│   │   _stack      │  │   _stack      │  │    _stack     │      │
│   │  .launch.py   │  │  .launch.py   │  │   .launch.py  │      │
│   └───────┬───────┘  └───────┬───────┘  └───────┬───────┘      │
│           │                  │                  │               │
│           ▼                  ▼                  ▼               │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│   │  camera     │    │  nav2       │    │  ik_server  │        │
│   │  detector   │    │  planner    │    │  gripper    │        │
│   │  tracker    │    │  controller │    │  trajectory │        │
│   └─────────────┘    └─────────────┘    └─────────────┘        │
│                                                                  │
│   Launch Arguments:                                              │
│   ros2 launch humanoid_bringup humanoid.launch.py \             │
│       use_sim:=true enable_perception:=true robot_name:=g1      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Overview

ROS 2 **launch files** orchestrate complex multi-node systems by starting nodes, setting parameters, configuring remappings, and managing lifecycle dependencies—all from a single command. Launch files replace manual terminal commands with declarative Python scripts that define system topology, making robotics stacks reproducible and maintainable.

**What You'll Build**: A comprehensive launch system that starts perception (camera), planning (IK server, grasp planner), and monitoring nodes with proper parameter configuration and conditional execution.

## Hardware Requirements

**Workstation** (from M1-C1-S1)
- ROS 2 Humble installed (M1-C1-S4)
- Python 3.10+

## Connection to Capstone

The capstone launch hierarchy:

1. **System Bringup** (`humanoid_bringup.launch.py`): Starts entire robot stack
2. **Perception Stack** (`perception.launch.py`): Camera, cuVSLAM, object detection
3. **Navigation Stack** (`navigation.launch.py`): Nav2, localization, path planning
4. **Manipulation Stack** (`manipulation.launch.py`): IK server, trajectory execution, gripper control
5. **Voice Stack** (`voice.launch.py`): Whisper ASR, LLM planner, TTS

Launch files enable **one-command startup** (`ros2 launch humanoid_bringup humanoid.launch.py`) instead of 20+ terminal commands.

## Implementation

### Launch File Anatomy

**Basic Launch File** (`example.launch.py`):
```python
from launch import LaunchDescription
from launch_ros.actions import Node

def generate_launch_description():
    return LaunchDescription([
        Node(
            package='humanoid_control',
            executable='ik_service_server.py',
            name='ik_server',
            output='screen',
            parameters=[{'workspace_limits': [0.3, 1.5]}]
        )
    ])
```

**Launch**:
```bash
ros2 launch humanoid_control example.launch.py
```

### Step 1: Basic Multi-Node Launch

**File**: `~/ros2_ws/src/humanoid_control/launch/perception_stack.launch.py`

```python
from launch import LaunchDescription
from launch_ros.actions import Node

def generate_launch_description():
    return LaunchDescription([
        # Camera controller with parameters
        Node(
            package='humanoid_control',
            executable='camera_controller.py',
            name='camera_controller',
            output='screen',
            parameters=[{
                'exposure': 10000,
                'gain': 20,
                'frame_rate': 30.0,
                'auto_exposure': False
            }]
        ),

        # Object detector (simulated)
        Node(
            package='humanoid_perception',
            executable='object_detector.py',
            name='object_detector',
            output='screen',
            parameters=[{
                'confidence_threshold': 0.7,
                'model_path': '/models/yolov8n.engine'
            }],
            remappings=[
                ('/camera/image', '/camera_controller/image_raw')
            ]
        ),

        # Grasp planner
        Node(
            package='humanoid_control',
            executable='grasp_planner.py',
            name='grasp_planner',
            output='screen'
        )
    ])
```

**Launch**:
```bash
ros2 launch humanoid_control perception_stack.launch.py
```

### Step 2: Launch with YAML Parameters

**Parameter File**: `~/ros2_ws/src/humanoid_control/config/perception_params.yaml`

```yaml
camera_controller:
  ros__parameters:
    exposure: 12000
    gain: 24
    frame_rate: 30.0
    auto_exposure: false
    camera_name: "realsense_d435i"

object_detector:
  ros__parameters:
    confidence_threshold: 0.75
    nms_threshold: 0.45
    model_path: "/models/yolov8n.engine"
    class_names: ["red_block", "blue_block", "coffee_mug", "book"]

grasp_planner:
  ros__parameters:
    min_grasp_quality: 0.5
    gripper_force_limit: 30.0  # Newtons
```

**Launch with YAML**:
```python
import os
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch_ros.actions import Node

def generate_launch_description():
    # Get package directory
    pkg_dir = get_package_share_directory('humanoid_control')
    config_file = os.path.join(pkg_dir, 'config', 'perception_params.yaml')

    return LaunchDescription([
        Node(
            package='humanoid_control',
            executable='camera_controller.py',
            name='camera_controller',
            output='screen',
            parameters=[config_file]
        ),
        Node(
            package='humanoid_perception',
            executable='object_detector.py',
            name='object_detector',
            output='screen',
            parameters=[config_file]
        ),
        Node(
            package='humanoid_control',
            executable='grasp_planner.py',
            name='grasp_planner',
            output='screen',
            parameters=[config_file]
        )
    ])
```

### Step 3: Conditional Launch (Launch Arguments)

**File**: `~/ros2_ws/src/humanoid_control/launch/humanoid_bringup.launch.py`

```python
import os
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, IncludeLaunchDescription
from launch.conditions import IfCondition, UnlessCondition
from launch.substitutions import LaunchConfiguration, PythonExpression
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch_ros.actions import Node

def generate_launch_description():
    # Declare launch arguments
    use_sim_arg = DeclareLaunchArgument(
        'use_sim',
        default_value='false',
        description='Use simulation (Gazebo) instead of real hardware'
    )

    enable_perception_arg = DeclareLaunchArgument(
        'enable_perception',
        default_value='true',
        description='Launch perception stack (camera, object detection)'
    )

    enable_navigation_arg = DeclareLaunchArgument(
        'enable_navigation',
        default_value='true',
        description='Launch navigation stack (Nav2)'
    )

    robot_name_arg = DeclareLaunchArgument(
        'robot_name',
        default_value='humanoid_01',
        description='Robot namespace'
    )

    # Get launch configurations
    use_sim = LaunchConfiguration('use_sim')
    enable_perception = LaunchConfiguration('enable_perception')
    enable_navigation = LaunchConfiguration('enable_navigation')
    robot_name = LaunchConfiguration('robot_name')

    # Package directories
    humanoid_control_dir = get_package_share_directory('humanoid_control')

    return LaunchDescription([
        # Declare arguments
        use_sim_arg,
        enable_perception_arg,
        enable_navigation_arg,
        robot_name_arg,

        # Real hardware nodes (only if not simulation)
        Node(
            package='realsense2_camera',
            executable='realsense2_camera_node',
            name='camera',
            namespace=robot_name,
            condition=UnlessCondition(use_sim),
            parameters=[{
                'depth_module.exposure': 10000,
                'rgb_camera.auto_exposure_priority': False
            }]
        ),

        # Simulation nodes (only if simulation)
        Node(
            package='gazebo_ros',
            executable='spawn_entity.py',
            name='spawn_humanoid',
            condition=IfCondition(use_sim),
            arguments=['-entity', robot_name, '-file', '/models/humanoid.urdf']
        ),

        # Perception stack (conditional)
        IncludeLaunchDescription(
            PythonLaunchDescriptionSource(
                os.path.join(humanoid_control_dir, 'launch', 'perception_stack.launch.py')
            ),
            condition=IfCondition(enable_perception)
        ),

        # IK server (always launch)
        Node(
            package='humanoid_control',
            executable='ik_service_server.py',
            name='ik_server',
            namespace=robot_name,
            output='screen'
        ),

        # Gripper controller (always launch)
        Node(
            package='humanoid_control',
            executable='gripper_controller.py',
            name='gripper_controller',
            namespace=robot_name,
            output='screen',
            parameters=[{
                'max_force': 30.0,
                'max_width': 0.08
            }]
        )
    ])
```

**Launch with Arguments**:
```bash
# Real hardware with perception and navigation
ros2 launch humanoid_control humanoid_bringup.launch.py

# Simulation only, no perception
ros2 launch humanoid_control humanoid_bringup.launch.py \
  use_sim:=true enable_perception:=false

# Real hardware, custom robot name
ros2 launch humanoid_control humanoid_bringup.launch.py \
  robot_name:=unitree_g1
```

**Show Launch Arguments**:
```bash
ros2 launch humanoid_control humanoid_bringup.launch.py --show-args
```

### Step 4: Nested Launch Files

**Modular Launch Structure**:
```
~/ros2_ws/src/humanoid_control/launch/
├── humanoid_bringup.launch.py       # Top-level orchestrator
├── perception_stack.launch.py       # Camera + detection
├── navigation_stack.launch.py       # Nav2 + localization
├── manipulation_stack.launch.py     # IK + trajectory exec
└── monitoring.launch.py             # Diagnostics + logging
```

**Top-Level Launch** (`humanoid_bringup.launch.py`):
```python
from launch import LaunchDescription
from launch.actions import IncludeLaunchDescription
from launch.launch_description_sources import PythonLaunchDescriptionSource
import os
from ament_index_python.packages import get_package_share_directory

def generate_launch_description():
    pkg_dir = get_package_share_directory('humanoid_control')

    return LaunchDescription([
        IncludeLaunchDescription(
            PythonLaunchDescriptionSource(
                os.path.join(pkg_dir, 'launch', 'perception_stack.launch.py')
            )
        ),
        IncludeLaunchDescription(
            PythonLaunchDescriptionSource(
                os.path.join(pkg_dir, 'launch', 'manipulation_stack.launch.py')
            )
        ),
        IncludeLaunchDescription(
            PythonLaunchDescriptionSource(
                os.path.join(pkg_dir, 'launch', 'monitoring.launch.py')
            )
        )
    ])
```

### Step 5: Event Handlers and Lifecycle Management

**Advanced Launch with Event Handlers**:
```python
from launch import LaunchDescription
from launch.actions import RegisterEventHandler, LogInfo, EmitEvent
from launch.event_handlers import OnProcessStart, OnProcessExit
from launch.events import Shutdown
from launch_ros.actions import Node, LifecycleNode
from launch_ros.event_handlers import OnStateTransition
from launch_ros.events.lifecycle import ChangeState
from lifecycle_msgs.msg import Transition

def generate_launch_description():
    # Lifecycle node (camera)
    camera_node = LifecycleNode(
        package='realsense2_camera',
        executable='realsense2_camera_node',
        name='camera',
        namespace='',
        output='screen'
    )

    # Regular node (object detector)
    detector_node = Node(
        package='humanoid_perception',
        executable='object_detector.py',
        name='object_detector',
        output='screen'
    )

    # Event: Configure camera when detector starts
    configure_camera = RegisterEventHandler(
        OnProcessStart(
            target_action=detector_node,
            on_start=[
                LogInfo(msg='Detector started, configuring camera...'),
                EmitEvent(event=ChangeState(
                    lifecycle_node_matcher=lambda node: node.name == 'camera',
                    transition_id=Transition.TRANSITION_CONFIGURE
                ))
            ]
        )
    )

    # Event: Shutdown system if camera exits
    shutdown_on_camera_exit = RegisterEventHandler(
        OnProcessExit(
            target_action=camera_node,
            on_exit=[
                LogInfo(msg='Camera node exited, shutting down system...'),
                EmitEvent(event=Shutdown(reason='Camera failure'))
            ]
        )
    )

    return LaunchDescription([
        camera_node,
        detector_node,
        configure_camera,
        shutdown_on_camera_exit
    ])
```

### Step 6: Package Installation

**Update CMakeLists.txt** to install launch files:
```cmake
# Install launch files
install(DIRECTORY
  launch
  DESTINATION share/${PROJECT_NAME}/
)

# Install config files
install(DIRECTORY
  config
  DESTINATION share/${PROJECT_NAME}/
)
```

**Build and Source**:
```bash
cd ~/ros2_ws
colcon build --packages-select humanoid_control
source install/setup.bash
```

## Launch File Best Practices

### 1. Use Descriptive Names

```python
# Good: Clear purpose
Node(package='nav2_controller', executable='controller_server', name='controller_server')

# Bad: Ambiguous
Node(package='nav2_controller', executable='controller_server', name='node1')
```

### 2. Group Related Nodes

```python
# Good: Logical grouping
perception_nodes = [camera_node, detector_node, tracker_node]
navigation_nodes = [planner_node, controller_node]

return LaunchDescription(perception_nodes + navigation_nodes)
```

### 3. Provide Default Arguments

```python
# Good: Sensible defaults
DeclareLaunchArgument('max_velocity', default_value='1.0')

# Bad: No default (user must always specify)
DeclareLaunchArgument('max_velocity')
```

### 4. Use Configuration Files

```python
# Good: Parameters in YAML
parameters=[config_file]

# Bad: Hardcoded parameters
parameters=[{'param1': 10, 'param2': 20, ..., 'param50': 100}]
```

### 5. Document Launch Arguments

```python
DeclareLaunchArgument(
    'robot_model',
    default_value='unitree_g1',
    description='Robot model: unitree_g1, unitree_go2, or custom',
    choices=['unitree_g1', 'unitree_go2', 'custom']
)
```

## Common Launch Patterns

### Pattern 1: Environment-Specific Config

```python
# Select config based on environment variable
import os
env = os.environ.get('ROBOT_ENV', 'development')
config_file = f'config/{env}_params.yaml'
```

### Pattern 2: Node Respawn on Failure

```python
Node(
    package='critical_node_pkg',
    executable='critical_node',
    name='critical_node',
    respawn=True,  # Auto-restart on crash
    respawn_delay=2.0  # Wait 2 seconds before restart
)
```

### Pattern 3: Delayed Node Start

```python
from launch.actions import TimerAction

# Start detector 5 seconds after launch
TimerAction(
    period=5.0,
    actions=[detector_node]
)
```

## Launch CLI Commands

| Command | Purpose | Example |
|---------|---------|---------|
| `ros2 launch <pkg> <file>` | Launch file | `ros2 launch humanoid_control humanoid.launch.py` |
| `ros2 launch <pkg> <file> <arg>:=<value>` | Pass argument | `ros2 launch humanoid_control humanoid.launch.py use_sim:=true` |
| `ros2 launch <pkg> <file> --show-args` | List arguments | `ros2 launch humanoid_control humanoid.launch.py --show-args` |
| `ros2 launch --launch-prefix` | Debug with prefix | `ros2 launch --launch-prefix 'gdb -ex run --args'` |

## Next Steps

With launch files mastered, proceed to:
- **M1-C2-S6**: QoS Policies (configure reliability and durability)
- **M1-C2-S7**: Rosbag Analysis (record and replay multi-node systems)
- **M1-C3-S1**: URDF Basics (robot description launched with RViz2)

**Troubleshooting**:
- **Launch file not found**: Ensure `install(DIRECTORY launch ...)` in CMakeLists.txt
- **Config file not found**: Use `get_package_share_directory()` for installed paths
- **Node doesn't start**: Check `output='screen'` to see error messages
- **Arguments not working**: Verify `LaunchConfiguration` matches `DeclareLaunchArgument` name

**Real-World Launch Examples**:
- Nav2: `nav2_bringup/launch/navigation_launch.py`
- MoveIt2: `moveit_resources_panda_moveit_config/launch/demo.launch.py`
- RealSense: `realsense2_camera/launch/rs_launch.py`

---

**Assessment Preparation**: This section is **ESSENTIAL** for **Assessment 1: ROS 2 Fundamentals Quiz (Week 3)**. You must demonstrate creating launch files with parameters, conditionals, and nested includes.
